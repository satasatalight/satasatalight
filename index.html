<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>satasite !</title>
    <link rel="icon" href=".\assets\images\bomberman-icon.png" type="image/x-icon">
    <!-- The style.css file allows you to change the look of your web pages.
         If you include the next line in all your web pages, they will all share the same look.
         This makes it easier to make new pages for your site. -->
    <link href="./assets/style.css" rel="stylesheet" type="text/css" media="all">
	
	<img id="muteButton" onclick="muteToggle()" src = ".\assets\images\noAudio.gif"></img>
	<script>
		//satatools
		let mute = true;
		let muteButton = document.getElementById("muteButton");
		let focusedAudio;
		
		window.onload = function(){
			focusedAudio = [document.getElementById('sataBgMusic')];
		}
		
		//copied this from https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/random
		function getRandomInt(max) { 
			return Math.floor(Math.random() * max);
		}
		
		//mute/unmute
		function muteToggle(){ 
			mute = !mute;
			
			//muting everything focused
			focusedAudio.forEach(element => element.muted = mute);
			
			//change icon
			if (mute) muteButton.src = "./assets/images/noAudio.gif";
			else muteButton.src = "./assets/images/audio.gif";
		}
		
		//referenced from https://stackoverflow.com/a/26869192
		function fadeAudio (sound, finalVolume, volumeIncrement) { 		
			let fadeAudio = setInterval(function () {
				// Only fade if past the fade out point or not at zero already
				if ( (sound.volume * volumeIncrement) <= ((finalVolume - volumeIncrement) * volumeIncrement) ) {
					sound.volume += volumeIncrement;
				} else{
					sound.volume = finalVolume;
					clearInterval(fadeAudio);
				}
			}, 200);
		}
	
		//runs on mouseover / touchstart of a category
		function enterCategory(audio){
			if (focusedAudio && audio.toString() != focusedAudio.toString()){ //checking if window loaded && if entering a new category
				//muting 
				focusedAudio.forEach(element => {
					fadeAudio(element, 0.0, -0.1)
				});
				
				focusedAudio = audio;//swapping to new audio
				
				//unmuting
				focusedAudio.forEach(element => {
					//updating mute state
					if(!mute)element.muted = false;
					else element.muted = true;
					
					//fading in
					fadeAudio(element, 1.0, 0.1);
				});
			} else audio.volume = 1; //failsafe
		}
	</script>
  </head>
  <body>
	
	<div class="category"  onmouseover="enterCategory([document.getElementById('sataBgMusic')])" ontouchstart="enterCategory([document.getElementById('sataBgMusic')])">
		
		<audio muted autoplay loop id="sataBgMusic">
			<source src="./assets/audio/SoKawaii-MarioArtistTalentStudio.mp3">
		</audio>
		
		<img id="satasiteBackground" class="background" src="./assets/images/satasiteBackground.jpg" alt="satasite background">
		
		<picture>
		  <source srcset=".\assets\images\satasiteMobile.gif" media="(aspect-ratio <= 1/1)">
		  <source srcset=".\assets\images\satasite.gif">
		  <img class="satasiteLogo" src=".\assets\satasite.gif" alt="satasite !">
		</picture> 
		
		<div class="links">
			<a href="https://twitter.com/sataIight"> <img src=".\assets\images\twitter.gif" style="float:left;" width="50%" height="100%" alt="twitter"> </a>
			<a href="https://tumblr.com/satalight"> <img src=".\assets\images\tumblr.gif" style="float:left;" width="50%" height="100%" alt="tumblr"> </a>
		</div>
		
		<img src=".\assets\images\down.gif" class="bottomCenter">
		
	</div>
	
	
	<div class="category" id="favorWidthWhenInMobileAspectRatio" onmouseover="enterCategory(sataTvAudioElements)" ontouchstart="enterCategory(sataTvAudioElements)">
		
		<div class="container">
			<img id="videoArchiveBackground" class="background" src="./assets/images/pkmnChannelMinusikachu.png" alt="sataTV background"></img>
			
			<video  class = "videoLayer" id= "static" src="https://i.imgur.com/56U9NSZ.mp4" autoplay muted loop> </video>
			<video  class = "videoLayer" id= "sataTV" src="https://i.imgur.com/KJW3r7J.mp4" hidden muted> </video>
		</div>
		
		<img id="pikachu" src= ".\assets\images\pikachu1.gif"></img>
	
		<img id="notification" src= ".\assets\images\pikachuIsEnthralled.gif"></img>
		
		<script>
			//satalight TV
			let staticChannel = document.getElementById("static");
			let sataTV = document.getElementById("sataTV");
			let pikachu = document.getElementById("pikachu");
			
			let sataTvAudioElements = [staticChannel, sataTV]; //shortcut
			
			let videoQueue;
			let playedVideos = [];
			let currentVideo;
			
			getVideoQueue();
			
			//pulling video list from imgur api 
			//heavily based on https://medium.com/@microaeris/getting-started-with-the-imgur-api-4e96c352658a
			function getVideoQueue(){
				let req = new XMLHttpRequest();
				req.open("GET", "https://api.imgur.com/3/album/8UAp6qX");
				req.setRequestHeader("Authorization", "Client-ID f707b5eca189982");
				req.send("null");
				req.onreadystatechange = function() { 
					if (req.readyState == 4 && req.status == 200) {
						videoQueue = JSON.parse(req.responseText).data.images;
						
						//setting up first video to play
						currentVideo = getRandomInt(videoQueue.length);
						sataTV.src = "https://i.imgur.com/" + videoQueue[currentVideo].id + ".mp4";
					} else {
						console.log("Error with Imgur Request.");
					}
				}
			}
			
			//play video once done loading..
			sataTV.oncanplay = function() {
				//..and waiting 2 seconds for static to play 
				setTimeout(function(){
					staticChannel.volume = 0;
					
					//changing from static to video
					changeChannel(sataTV, staticChannel);
					
					sataTV.onended = function(){ 
						//changing from video to static
						changeChannel(staticChannel,sataTV);
						changeVideo();
					}
				}, 2000);
			}
			
			//i called them 'newvideo' and 'oldvideo' but theyre actually channels, fuck you
			function changeChannel(newVideo, oldVideo){
				//getting rid of old channel
				oldVideo.hidden = true;
				
				//setting up new channel
				newVideo.play();
				newVideo.hidden = false;
			}
			
			//changing video
			function changeVideo(){
				playedVideos.push(videoQueue[currentVideo]); //add played video to played queue
				videoQueue.splice(currentVideo,1); //delete played video
				
				if (videoQueue.length == 0){ //repeat if queue is done
					videoQueue = playedVideos;
					playedVideos = [];
				}
				
				currentVideo = getRandomInt(videoQueue.length); //pull new video
				sataTV.src = "https://i.imgur.com/" + videoQueue[currentVideo].id + ".mp4"; //load new video
				
				//pikachu ai
				let pikachuChoice = getRandomInt(3); 
				
				if (pikachuChoice == 0){ //random pikachu pose
					pikachuChange((getRandomInt(2) + 1).toString());
				} if (pikachuChoice == 1){ //pikachu turn
					pikachuChange("3");
					setTimeout(function(){ pikachuChange((getRandomInt(2) + 1).toString()); }, 2370); //switching back to pose after turn
				}
			}
			
			//change pikachu pose
			function pikachuChange(index){
				pikachu.src = "./assets/images/pikachu" + index + ".gif";
			}
			
			//roll for notification gif every loop (3.33 seconds)
			setInterval(function() {
				document.getElementById("notification").hidden  = true;
				if (getRandomInt(30) == 0){ //1 in 30 chance of notification
					document.getElementById("notification").hidden = false;
				}
			}, 3330);
		</script>
	</div>
  </body>
</html>
